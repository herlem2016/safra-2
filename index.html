<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, user-scalable=0">
    <title>SAFRA</title>
    <script src="cordova.js"></script>
    <script src="script.js"></script>
    <style>
		html,body{position:relative;width:100%;height:100%;margin:0px;}
	</style>
</head>
<body>
	<iframe id="app" name="app" src="http://demo.safra.softronel.com.mx/ui/mobile/safra/index.html" style="margin:0px;height:100%;width:100%;border:0px;" border="0px;"></iframe>
	<script>
		
		
		function downloadFile(url, filename) {
			alert("intento de abrir:" + url + "; " + filename);
			var fileTransfer = new FileTransfer();
			var localpath = cordova.file.externalDataDirectory + filename;
			fileTransfer.download(encodeURI(url),
				localpath,
				function (thefile) {
					var localpath = thefile.toURL();
					try {
						cordova.plugins.fileOpener2.open(
							localpath,
							(extension == "xlsx" ? "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" : (extension == "img" ? "image/png" : "application/pdf")),
							{
								error: function(){},
								success: function(){}
							}
						);
					} catch(e){}
				},
				function(error){
					alert("Falló descarga de archivo.");
				}
			);
		}
		
		window.onload=function(){
			try {document.addEventListener("deviceready", ondeviceready, false);} catch (e) {}
		}
		
		var ondeviceready = function () {
			window.frames["app"].postMessage({funcion:"IsPhoneGap",params:[true]},'*');
			FCMPlugin.onNotification(function(data){
				cordova.plugins.notification.badge.increase(1, function () { }); 
				/*if(data.wasTapped){
					cordova.plugins.notification.badge.set(0);
				}*/
				if (data.modulo == 1){
					window.frames["app"].postMessage({funcion:"ActivarAlarma_",params:[data.contenidovoz]},'*');
				}else{
					window.frames["app"].postMessage({funcion:"PantallaMostrar",params:["notificaciones", "section"]},'*');
				} 
			});
		}
		
		var i_unsubs = 0;
		function DesSuscribirNotificaciones(datos){
			if (i_unsubs < datos.length){
				alert("Registro des " + datos[i_unsubs]);
				FCMPlugin.unsubscribeFromTopic(datos[i_unsubs], function () {
					if (i_unsubs < l_s) {DesSuscribirNotificaciones(datos);}
				});
			}
		}

		var i_subs = 0;
		function SuscribirNotificaciones(datos) {
			if (i_subs < datos.length){
				alert("Registro " + datos[i_subs]);
				FCMPlugin.subscribeToTopic(datos[i_subs++], function(){
					SuscribirNotificaciones(datos); 
				});
			}
		}	
				
		function ObtenerImagenes(){
			window.frames["app"].postMessage(img,'*');
		}
				
		window.addEventListener("message", function(event) {
			try{
				window[event.data.funcion](...event.data.datos);
			}catch(e){alert(e.message);}
		}, false);
		
    </script>
</body>
</html>
